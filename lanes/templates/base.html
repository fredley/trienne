{% load safe_js %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chat Room</title>
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/chat.css" rel="stylesheet">
</head>

<body>
  <header class="navbar navbar-static-top">
    <div class="container">
      <div class="navbar-header">
        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
        <ul class="nav navbar-nav">
          <li class="">
            <a href="{% url 'room' 1 %}">Room 1</a>
          </li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown" style="margin-right: 12em;">
          {% if request.user.is_authenticated %}
            <a class="dropdown-toggle" href="#" data-toggle="dropdown">{{ request.user.get_full_name }} <span class="caret"></span></a>
            <div class="dropdown-menu" style="padding:1em;">
              <form class="form" action="{% url 'logout' %}" method="post">{% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                <input class="btn btn-success btn-block" type="submit" value="Logout">
              </form>
            </div>
          {% else %}
            <a class="dropdown-toggle" href="#" data-toggle="dropdown">Login <span class="caret"></span></a>
            <div class="dropdown-menu" style="padding:1em;">
              <p class="help-block">Login as <em>john</em> or <em>mary</em> using password <em>secret</em>.</p>
              <form class="form" action="{% url 'login' %}" method="post">{% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                <div class="form-group">
                  <input class="form-control" placeholder="Username" name="username" type="text">
                </div>
                <div class="form-group">
                  <input class="form-control" placeholder="Password" name="password" type="password" value="">
                </div>
                <input class="btn btn-success btn-block" type="submit" value="Login">
              </form>
            </div>
          {% endif %}
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container" id="main">
    {% block main_content %}
    <div class="row">
      <div class="col-sm-4 pane" id="slow">
        {% block introduction %}{% endblock introduction %}
      </div>
      <div class="col-sm-4 pane" id="medium">
      </div>
      <div class="col-sm-4 pane" id="fast">
        <div id="messages"></div>
      </div>
    </div>
    {% endblock main_content %}
  </div>
  <footer>
    <div id="entry">
      <div "form-inline">
        <div class="form-group">
          <textarea class="form-control" id="megaphone" ></textarea>
        </div>
      </div>
    </div>
  </footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="/static/js/ws4redis.js" type="text/javascript"></script>
  <script type="text/javascript">
  jQuery(document).ready(function($) {

    var sock = WS4Redis({
      uri: '{{ WEBSOCKET_URI }}room_{{ room.id }}?subscribe-broadcast&publish-broadcast&echo',
      receive_message: receiveMessage,
      heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
    });
    var messages = $('#messages');

    var post_history = [
      {% for post in room.history %}
        {
          author: {
              name: "{{ post.author.username }}",
              id: {{ post.author.id }}
          },
          content: '{{ post.content|multiline|safe }}',
          id: {{ post.id }}
        },
      {% endfor %}
    ];

    window.pinned = [
      {% for post in room.pinned %}
        {
          author: {
              name: "{{ post.author.username }}",
              id: {{ post.author.id }}
          },
          content: "{{ post.content|multiline|safe }}",
          id: {{ post.id }}
        },
      {% endfor %}
    ];

    post_history.forEach(appendFastMessage);
    pinned.forEach(function(el){
      insertMediumMessage(createMessage(el));
    });

    $("#megaphone").keydown(function(ev) {
      if (ev.keyCode === 13 && !ev.shiftKey) {
        ev.preventDefault();
        var message = $('#megaphone').val();
        if (message !== ""){
          $.ajax({
            method: "post",
            url: "{% url 'room_post' room.id %}",
            data: {
              message: message
            }
          });
          $('#megaphone').val("");
        }
      }
    });

    function createMessage(msg) {
      var message = $('<div class="message"></div>')
        .append($('<div class="content"></div>').html(msg.content));
      var controls = $('<div class="controls"></div>')
      var pin = $('<i class="glyphicon glyphicon-pushpin pin"></i>');
      var id = msg.id;
      pin.on('click', function(){
        $.ajax({
          method: "post",
          url: "{% url 'room_pin' room.id %}",
          data: {
            id: id,
            pin: true
          }
        });
      });
      controls.append(pin);
      message.append(controls);
      message.addClass("msg-" + id);
      message.attr("data-id", id);
      return message;
    }

    function insertFastMessage (message, author) {
      // Is the last post by the same author? If so, concat
      var last = messages.find('.author').last();
      if (last.attr('data-id') == author.id){
        last.append(message);
      } else {
        messages.append($('<div class="author"></div>')
          .text(author.name)
          .attr('data-id', author.id)
          .append(message));
      }
      messages.scrollTop(messages.scrollTop() + 9999);
    }

    function appendFastMessage (msg) {
      if($('#messages .msg-'+msg.id).length === 0){
        insertFastMessage(createMessage(msg), msg.author);
      }
    }

    function insertMediumMessage (message) {
      $('#medium').prepend(message);
      $('.msg-' + message.attr('data-id')).find('.pin').addClass('active');
    }

    function receiveMessage(msg) {
      console.log(msg);
      var msg = JSON.parse(msg);
      if (msg.type == "msg"){
        appendFastMessage(msg);
      } else if (msg.type == "pin") {
        if (msg.action == "pin") {
          var message = $("#messages .msg-" + msg.content);
          if ($('#medium').find('.msg-' + msg.content).length === 0) { 
            insertMediumMessage(message.clone(true));
          }
        } else if (msg.action == "unpin") {
          var message = $("#medium .msg-" + msg.content);
          message.remove();
          $('.msg-' + msg.content).find('.pin').removeClass('active');
        }
      }
    }
  });
  </script>
</body>

</html>